<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Activity Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fb;
      --surface: #ffffff;
      --border: #e0e4ef;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #e0ecff;
      --radius-lg: 16px;
      --radius-sm: 8px;
      --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #eef2ff 0, #f5f7fb 40%, #f9fafb 100%);
      color: var(--text-main);
    }

    .app {
      max-width: 1120px;
      margin: 24px auto 32px;
      padding: 0 16px;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.25);
      margin-bottom: 16px;
    }

    header {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .tag {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(37, 99, 235, 0.25);
      white-space: nowrap;
    }

    .credit {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .credit a {
      color: #2563eb;
      font-weight: 600;
      text-decoration: none;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .controls-row label {
      font-size: 12px;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    input[type="month"],
    select {
      font-family: inherit;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--text-main);
    }

    .controls-right {
      margin-left: auto;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      font-family: inherit;
      font-size: 12px;
      border-radius: 999px;
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, box-shadow 0.15s ease,
        transform 0.05s ease;
    }

    .btn-primary {
      background: #2563eb;
      color: #f9fafb;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.25);
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-ghost {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #e5e7eb;
    }

    .btn-ghost:hover {
      background: #e5e7eb;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .table-wrapper {
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow-x: auto;
      background: #ffffff;
      margin-top: 6px;
    }

    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #f9fafb;
    }

    th,
    td {
      padding: 8px 8px;
      border-bottom: 1px solid #edf0f7;
      text-align: left;
      vertical-align: middle;
    }

    th {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tbody tr:nth-child(even) {
      background: #fdfdff;
    }

    tbody tr:hover {
      background: #f3f6ff;
    }

    .col-day {
      width: 70px;
      text-align: center;
      font-weight: 600;
    }

    .activity-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px;
    }

    .activity-title {
      font-size: 11px;
      text-transform: none;
      letter-spacing: normal;
      color: #111827;
      font-weight: 600;
      cursor: pointer;
    }

    .header-actions {
      display: inline-flex;
      gap: 2px;
    }

    .icon-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 2px;
      font-size: 11px;
      color: #9ca3af;
    }

    .icon-btn:hover {
      color: #4b5563;
    }

    /* Activity cell as a single progress-bar field */

    .activity-cell {
      text-align: center;
    }

    .activity-field {
      position: relative;
      border-radius: 6px;
      border: 1px solid var(--border);
      height: 32px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #374151;
      cursor: pointer;
      background: #f3f4f6;
    }

    .activity-fill {
      position: absolute;
      inset: 0;
      width: 0%;
      transition: width 0.25s ease, background 0.25s ease, opacity 0.15s ease;
      opacity: 0.9;
    }

    .activity-label {
      position: relative;
      z-index: 1;
      pointer-events: none;
      padding: 0 6px;
      white-space: nowrap;
    }

    /* Stage colors for activity fill */
    .activity-fill.stage-0 { background: #9ca3af; }   /* not set */
    .activity-fill.stage-1 { background: #fed7aa; }   /* 25% */
    .activity-fill.stage-2 { background: #facc15; }   /* 50% */
    .activity-fill.stage-3 { background: #4ade80; }   /* 75% */
    .activity-fill.stage-4 { background: #22c55e; }   /* 100% */

    /* Danger override for "Couldn't do today" */
    .activity-fill.danger {
      background: #fecaca !important;
    }

    /* Hidden dropdown over the whole field, arrow removed */
    .activity-select {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      border: none;
      margin: 0;
      padding: 0;
      background: transparent;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: none;
      font-size: 13px;
    }

    /* Daily overview linear bar */

    .overview-cell {
      width: 220px;
    }

    .overview-linear {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-start;
    }

    .overview-linear-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .overview-linear-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      transition: width 0.2s ease, background 0.15s ease;
    }

    .overview-linear-label {
      font-size: 11px;
      color: #6b7280;
    }

    .overview-linear-label strong {
      font-weight: 500;
      color: #111827;
    }

    /* Stage colors for overview fill */
    .overview-linear.stage-0 .overview-linear-fill { background: #9ca3af; }
    .overview-linear.stage-1 .overview-linear-fill { background: #f97316; }
    .overview-linear.stage-2 .overview-linear-fill { background: #facc15; }
    .overview-linear.stage-3 .overview-linear-fill { background: #22c55e; }
    .overview-linear.stage-4 .overview-linear-fill { background: #16a34a; }

    .overview-linear.danger .overview-linear-fill {
      background: #fecaca !important;
    }

    .footer-bar {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-muted);
    }

    .summary {
      font-weight: 500;
    }

    .footer-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .footer-credit {
      font-size: 11px;
      color: #9ca3af;
    }

    .footer-credit a {
      color: #2563eb;
      text-decoration: none;
      font-weight: 600;
    }

    .compare-bar {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
      font-size: 12px;
      color: #4b5563;
    }

    .compare-summary-strong {
      font-weight: 600;
    }

    /* Year overview */

    .year-header {
      margin-bottom: 10px;
    }

    .year-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .year-header p {
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .year-progress-wrap {
      margin-bottom: 10px;
    }

    .year-progress-label {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 4px;
    }

    .year-progress-track {
      width: 100%;
      height: 9px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .year-progress-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: #2563eb;
      transition: width 0.25s ease;
    }

    .year-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    .year-month-card {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      background: #f9fafb;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
    }

    .year-month-card:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }

    .year-month-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .year-month-main {
      font-size: 16px;
      font-weight: 600;
    }

    .year-month-meta {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .year-month-card.is-compare {
      border-color: #2563eb;
      background: #e0ecff;
    }

    @media (max-width: 640px) {
      .app {
        margin: 16px auto 24px;
        padding: 0 8px;
      }

      .card {
        padding: 14px;
        border-radius: 12px;
      }

      header h1 {
        font-size: 18px;
      }

      header p {
        font-size: 12px;
      }

      th,
      td {
        padding: 4px 4px;
        font-size: 11px;
      }

      .activity-field {
        height: 26px;
        font-size: 10px;
      }

      .overview-cell {
        width: 180px;
      }

      .table-wrapper {
        border-radius: 10px;
      }
    }

    /* Customize mode visibility */

    .customize-off .customize-only {
      display: none !important;
    }

    .customize-off .header-actions {
      display: none !important;
    }

    .customize-on .customize-only {
      display: inline-flex;
    }

    .customize-on .header-actions {
      display: inline-flex;
    }

    /* Compare-locked: inputs disabled */

    .compare-locked .activity-field {
      opacity: 0.65;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="app customize-off" id="appRoot">
    <!-- Main tracker card -->
    <div class="card">
      <header>
        <div>
          <h1>Daily Activity Tracker</h1>
          <p>
            Customisable daily activities with monthly views, correct day counts, visual completion, and streak insights.
          </p>
          <div class="credit">
            Designed and iterated as a personal tracking tool by
            <a href="https://rakibhossain.dev/" target="_blank">Rakib Hossain</a>.
          </div>
        </div>
        <span class="tag">Custom activities Â· Monthly view Â· Compare & streaks</span>
      </header>

      <div class="controls-row">
        <label>
          Month
          <input type="month" id="monthPicker">
        </label>

        <label>
          Compare with
          <select id="compareSelect">
            <option value="">None</option>
          </select>
        </label>

        <div class="controls-right">
          <button class="btn btn-ghost" id="customizeToggle">
            âš™ Customize
          </button>
          <button class="btn btn-primary customize-only" id="addActivityBtn">
            + Add activity column
          </button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead id="tableHead"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="compare-bar">
        <span id="compareSummary">
          Select another month or click a month card below to compare your average completion, streaks, and consistency.
        </span>
      </div>

      <div class="footer-bar">
        <div>
          <div class="summary" id="summaryText">No data yet.</div>
          <div class="footer-note">
            Activities and layout are shared across months. Each month keeps its own progress, streaks, and averages.
          </div>
          <div class="footer-credit">
            Daily Activity Tracker v3.1 Â· Designed for year-round tracking by
            <a href="https://rakibhossain.dev/" target="_blank">Rakib Hossain</a>.
          </div>
        </div>
        <button type="button" class="btn btn-ghost" id="resetCurrentMonth">
          Clear current month
        </button>
      </div>
    </div>

    <!-- Year overview dashboard -->
    <div class="card">
      <div class="year-header">
        <h2>Year overview</h2>
        <p>
          Monthly summary with average completion, days tracked, perfect days, and longest streak per month.
        </p>
      </div>

      <div class="year-progress-wrap">
        <div class="year-progress-label" id="yearProgressLabel">
          No tracked days yet. Once you log activity, this will show your yearly average completion.
        </div>
        <div class="year-progress-track">
          <div class="year-progress-fill" id="yearProgressFill"></div>
        </div>
      </div>

      <div id="yearGrid" class="year-grid"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "daily_activity_tracker_v3_0";

    const ACTIVITY_OPTIONS = [
      { value: "none",   label: "âšª Not set",              pct: 0 },
      { value: "unable", label: "â›” Couldn't do today",    pct: 0 },
      { value: "25",     label: "ðŸŸ¡ 25% done",            pct: 25 },
      { value: "50",     label: "ðŸŸ¡ 50% done",            pct: 50 },
      { value: "75",     label: "ðŸŸ¢ 75% done",            pct: 75 },
      { value: "100",    label: "âœ… 100% completed",      pct: 100 },
    ];

    const monthPicker = document.getElementById("monthPicker");
    const compareSelect = document.getElementById("compareSelect");
    const tableHead = document.getElementById("tableHead");
    const tableBody = document.getElementById("tableBody");
    const addActivityBtn = document.getElementById("addActivityBtn");
    const summaryText = document.getElementById("summaryText");
    const compareSummary = document.getElementById("compareSummary");
    const resetCurrentMonthBtn = document.getElementById("resetCurrentMonth");
    const yearGrid = document.getElementById("yearGrid");
    const yearProgressLabel = document.getElementById("yearProgressLabel");
    const yearProgressFill = document.getElementById("yearProgressFill");
    const customizeToggle = document.getElementById("customizeToggle");
    const appRoot = document.getElementById("appRoot");

    let state = null;
    let currentMonthKey = null;
    let customizeMode = false;

    function getMonthKey(year, monthIndex) {
      return `${year}-${String(monthIndex + 1).padStart(2, "0")}`;
    }

    function getDaysInMonth(year, monthIndex) {
      return new Date(year, monthIndex + 1, 0).getDate();
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      try {
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : null;
      } catch (_) {
        return null;
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function initState() {
      const existing = loadState();
      if (existing && Array.isArray(existing.activities) && existing.months) {
        state = existing;
      } else {
        const today = new Date();
        const year = today.getFullYear();
        const monthIndex = today.getMonth();
        const key = getMonthKey(year, monthIndex);
        const days = getDaysInMonth(year, monthIndex);

        state = {
          activities: ["Trading", "Coding", "Automation", "Self-Care", "Prayer"],
          months: {}
        };

        state.months[key] = {
          year,
          monthIndex,
          days,
          data: Array.from({ length: days }, () => ({
            activities: state.activities.map(() => "none"),
            overview: null
          }))
        };
      }

      const today = new Date();
      const todayKey = getMonthKey(today.getFullYear(), today.getMonth());
      if (state.months[todayKey]) {
        currentMonthKey = todayKey;
      } else {
        const keys = Object.keys(state.months);
        currentMonthKey = keys.length ? keys[0] : todayKey;
        if (!state.months[currentMonthKey]) {
          const [y, m] = currentMonthKey.split("-").map(Number);
          const year = y;
          const monthIndex = m - 1;
          const days = getDaysInMonth(year, monthIndex);
          state.months[currentMonthKey] = {
            year,
            monthIndex,
            days,
            data: Array.from({ length: days }, () => ({
              activities: state.activities.map(() => "none"),
              overview: null
            }))
          };
        }
      }
    }

    function ensureMonth(year, monthIndex) {
      const key = getMonthKey(year, monthIndex);
      if (!state.months[key]) {
        const days = getDaysInMonth(year, monthIndex);
        state.months[key] = {
          year,
          monthIndex,
          days,
          data: Array.from({ length: days }, () => ({
            activities: state.activities.map(() => "none"),
            overview: null
          }))
        };
      } else {
        const m = state.months[key];
        const days = getDaysInMonth(year, monthIndex);
        m.days = days;
        if (m.data.length !== days) {
          const newData = Array.from({ length: days }, (_, idx) => {
            if (m.data[idx]) {
              const row = m.data[idx];
              if (!Array.isArray(row.activities)) {
                row.activities = state.activities.map(() => "none");
              } else {
                if (row.activities.length < state.activities.length) {
                  while (row.activities.length < state.activities.length) {
                    row.activities.push("none");
                  }
                } else if (row.activities.length > state.activities.length) {
                  row.activities = row.activities.slice(0, state.activities.length);
                }
              }
              return row;
            } else {
              return {
                activities: state.activities.map(() => "none"),
                overview: null
              };
            }
          });
          m.data = newData;
        } else {
          m.data.forEach(row => {
            if (!Array.isArray(row.activities)) {
              row.activities = state.activities.map(() => "none");
            } else {
              if (row.activities.length < state.activities.length) {
                while (row.activities.length < state.activities.length) {
                  row.activities.push("none");
                }
              } else if (row.activities.length > state.activities.length) {
                row.activities = row.activities.slice(0, state.activities.length);
              }
            }
          });
        }
      }
      return state.months[key];
    }

    function getPctFromValue(value) {
      const opt = ACTIVITY_OPTIONS.find(o => o.value === value);
      return opt ? opt.pct : 0;
    }

    function stageFromActivityValue(value) {
      switch (value) {
        case "25":   return { stage: 1, label: "25% done" };
        case "50":   return { stage: 2, label: "50% done" };
        case "75":   return { stage: 3, label: "75% done" };
        case "100":  return { stage: 4, label: "Completed" };
        case "unable": return { stage: 0, label: "Couldn't do today" };
        default:     return { stage: 0, label: "Not set" };
      }
    }

    function stageFromOverview(overview) {
      if (overview === null || isNaN(overview)) {
        return { stage: 0, label: "Not set", danger: false };
      }
      if (overview === 0) {
        return { stage: 0, label: "No progress", danger: true };
      }
      if (overview < 40) {
        return { stage: 1, label: "Light progress", danger: false };
      }
      if (overview < 70) {
        return { stage: 2, label: "Moderate progress", danger: false };
      }
      if (overview < 100) {
        return { stage: 3, label: "Strong progress", danger: false };
      }
      return { stage: 4, label: "Perfect day", danger: false };
    }

    function updateActivityCell(monthKey, dayIndex, activityIndex) {
      const month = state.months[monthKey];
      if (!month) return;
      const val = month.data[dayIndex].activities[activityIndex];
      const pct = getPctFromValue(val);
      const { stage, label } = stageFromActivityValue(val);

      const select = document.querySelector(
        `select[data-month="${monthKey}"][data-day="${dayIndex}"][data-activity="${activityIndex}"]`
      );
      if (!select) return;

      const field = select.parentNode;
      const fill = field.querySelector(".activity-fill");
      const labelEl = field.querySelector(".activity-label");

      let width = pct;
      if (val === "unable") {
        width = 100;
      }

      fill.style.width = width + "%";
      fill.className = "activity-fill stage-" + stage + (val === "unable" ? " danger" : "");
      labelEl.textContent = label;
    }

    function updateOverviewForDay(monthKey, dayIndex) {
      const month = state.months[monthKey];
      if (!month) return;
      const day = month.data[dayIndex];
      let sum = 0;
      let count = 0;
      let allZero = true;

      day.activities.forEach((val) => {
        const pct = getPctFromValue(val);
        if (val === "none") return;
        count++;
        sum += pct;
        if (pct > 0) allZero = false;
      });

      let overview = null;
      if (count > 0) {
        overview = Math.round(sum / count);
        if (allZero) overview = 0;
      } else {
        overview = null;
      }
      day.overview = overview;

      const wrap = document.querySelector(
        `div[data-month-overview="${monthKey}"][data-overview-linear="${dayIndex}"]`
      );
      if (!wrap) return;
      const fill = wrap.querySelector(".overview-linear-fill");
      const labelEl = wrap.querySelector(".overview-linear-label");

      const { stage, label, danger } = stageFromOverview(overview);
      wrap.className = "overview-linear stage-" + stage + (danger ? " danger" : "");

      const width = overview === null || isNaN(overview) ? 0 : overview;
      fill.style.width = width + "%";

      if (overview === null || isNaN(overview)) {
        labelEl.innerHTML = `<strong>${label}</strong>`;
      } else {
        labelEl.innerHTML = `<strong>${label}</strong> Â· ${overview}%`;
      }
    }

    function computeLongestStreakForMonth(monthKey) {
      const month = state.months[monthKey];
      if (!month) return 0;
      let longest = 0;
      let current = 0;
      month.data.forEach((day) => {
        const ov = day.overview;
        const active = ov !== null && !isNaN(ov) && ov > 0;
        if (active) {
          current++;
          if (current > longest) longest = current;
        } else {
          current = 0;
        }
      });
      return longest;
    }

    function computeMonthStats(monthKey) {
      const month = state.months[monthKey];
      if (!month) return { avg: null, daysTracked: 0, perfectDays: 0, longestStreak: 0 };
      let daysWith = 0;
      let sum = 0;
      let perfect = 0;
      month.data.forEach((day) => {
        if (day.overview !== null && !isNaN(day.overview)) {
          daysWith++;
          sum += day.overview;
          if (day.overview === 100) perfect++;
        }
      });
      const longestStreak = computeLongestStreakForMonth(monthKey);
      if (daysWith === 0) return { avg: null, daysTracked: 0, perfectDays: 0, longestStreak };
      return { avg: Math.round(sum / daysWith), daysTracked: daysWith, perfectDays: perfect, longestStreak };
    }

    function updateSummaryForCurrentMonth() {
      const stats = computeMonthStats(currentMonthKey);
      if (stats.daysTracked === 0) {
        summaryText.textContent = "No daily completion data yet for this month.";
      } else {
        summaryText.textContent =
          `Average completion this month: ${stats.avg}% Â· Perfect days (100%): ${stats.perfectDays} Â· Longest streak: ${stats.longestStreak} days`;
      }
    }

    function renderMonthPicker() {
      const month = state.months[currentMonthKey];
      if (!month) return;
      const year = month.year;
      const monthIndex = month.monthIndex;
      const value = `${year}-${String(monthIndex + 1).padStart(2, "0")}`;
      monthPicker.value = value;
    }

    function renderCompareSelect() {
      const keys = Object.keys(state.months).sort();
      const current = currentMonthKey;
      const selected = compareSelect.value;
      compareSelect.innerHTML = "";
      const optNone = document.createElement("option");
      optNone.value = "";
      optNone.textContent = "None";
      compareSelect.appendChild(optNone);

      keys.forEach((key) => {
        if (key === current) return;
        const m = state.months[key];
        const option = document.createElement("option");
        option.value = key;
        const label = `${m.year}-${String(m.monthIndex + 1).padStart(2, "0")}`;
        option.textContent = label;
        compareSelect.appendChild(option);
      });

      // restore previous selection if still valid
      if (selected && keys.includes(selected) && selected !== current) {
        compareSelect.value = selected;
      } else {
        compareSelect.value = "";
      }
    }

    function setInputsEnabled(enabled) {
      const selects = document.querySelectorAll(".activity-select");
      selects.forEach(sel => { sel.disabled = !enabled; });
      if (enabled) {
        appRoot.classList.remove("compare-locked");
      } else {
        appRoot.classList.add("compare-locked");
      }
    }

    function updateComparison() {
      const otherKey = compareSelect.value;
      if (!otherKey) {
        compareSummary.textContent =
          "Select another month or click a month card below to compare your average completion, streaks, and consistency.";
        setInputsEnabled(true);
        highlightCompareMonthCard(null);
        return;
      }

      const currentStats = computeMonthStats(currentMonthKey);
      const otherStats = computeMonthStats(otherKey);

      const curLabel = currentStats.avg === null ? "â€“" : `${currentStats.avg}%`;
      const otherLabel = otherStats.avg === null ? "â€“" : `${otherStats.avg}%`;

      let diffText = "";
      if (currentStats.avg !== null && otherStats.avg !== null) {
        const diff = currentStats.avg - otherStats.avg;
        if (diff > 0) {
          diffText = `Current month is <strong>+${diff} points</strong> above the comparison month.`;
        } else if (diff < 0) {
          diffText = `Current month is <strong>${diff} points</strong> below the comparison month.`;
        } else {
          diffText = `Both months have the <strong>same average</strong>.`;
        }
      }

      compareSummary.innerHTML =
        `<strong>Current month</strong> â€” Avg: ${curLabel}, ` +
        `Days tracked: ${currentStats.daysTracked}, ` +
        `Perfect days: ${currentStats.perfectDays}, ` +
        `Longest streak: ${currentStats.longestStreak} days<br>` +
        `<strong>Comparison month</strong> â€” Avg: ${otherLabel}, ` +
        `Days tracked: ${otherStats.daysTracked}, ` +
        `Perfect days: ${otherStats.perfectDays}, ` +
        `Longest streak: ${otherStats.longestStreak} days` +
        (diffText ? `<br>${diffText}` : "");

      // lock inputs while comparing
      setInputsEnabled(true); // first ensure DOM exists
      setInputsEnabled(false);
      highlightCompareMonthCard(otherKey);
    }

    function monthName(index) {
      return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][index] || "";
    }

    function renderYearOverview() {
      const keys = Object.keys(state.months).sort();
      yearGrid.innerHTML = "";

      if (!keys.length) {
        yearGrid.innerHTML = "<div style='font-size:12px;color:#6b7280;'>No month data yet.</div>";
        yearProgressLabel.textContent =
          "No tracked days yet. Once you log activity, this will show your yearly average completion.";
        yearProgressFill.style.width = "0%";
        return;
      }

      let globalSum = 0;
      let globalCount = 0;
      let globalLongestStreak = 0;

      keys.forEach((key) => {
        const stats = computeMonthStats(key);
        if (stats.avg !== null && stats.daysTracked > 0) {
          globalSum += stats.avg * stats.daysTracked;
          globalCount += stats.daysTracked;
        }
        if (stats.longestStreak > globalLongestStreak) {
          globalLongestStreak = stats.longestStreak;
        }
      });

      if (globalCount === 0) {
        yearProgressLabel.textContent =
          "No tracked days yet. Once you log activity, this will show your yearly average completion.";
        yearProgressFill.style.width = "0%";
      } else {
        const globalAvg = Math.round(globalSum / globalCount);
        yearProgressLabel.textContent =
          `Yearly average completion: ${globalAvg}% Â· Longest streak across months: ${globalLongestStreak} days`;
        yearProgressFill.style.width = `${globalAvg}%`;
      }

      const compareKey = compareSelect.value || null;

      keys.forEach((key) => {
        const m = state.months[key];
        const stats = computeMonthStats(key);
        const card = document.createElement("div");
        card.className = "year-month-card";
        card.dataset.monthKey = key;
        if (compareKey && key === compareKey) {
          card.classList.add("is-compare");
        }

        const title = document.createElement("div");
        title.className = "year-month-title";
        title.textContent = `${monthName(m.monthIndex)} ${m.year}`;

        const main = document.createElement("div");
        main.className = "year-month-main";
        main.textContent = stats.avg === null ? "â€“" : `${stats.avg}% avg`;

        const meta = document.createElement("div");
        meta.className = "year-month-meta";
        meta.textContent =
          `Days tracked: ${stats.daysTracked} Â· Perfect days: ${stats.perfectDays} Â· Longest streak: ${stats.longestStreak} days`;

        card.appendChild(title);
        card.appendChild(main);
        card.appendChild(meta);

        card.addEventListener("click", () => {
          if (key === currentMonthKey) {
            // clicking current month clears comparison
            compareSelect.value = "";
          } else {
            compareSelect.value = key;
          }
          updateComparison();
          renderYearOverview(); // refresh highlight
        });

        yearGrid.appendChild(card);
      });
    }

    function highlightCompareMonthCard(compareKey) {
      const cards = document.querySelectorAll(".year-month-card");
      cards.forEach(card => {
        const key = card.dataset.monthKey;
        if (compareKey && key === compareKey) {
          card.classList.add("is-compare");
        } else {
          card.classList.remove("is-compare");
        }
      });
    }

    function buildTable() {
      const month = state.months[currentMonthKey];
      if (!month) return;

      ensureMonth(month.year, month.monthIndex);

      tableHead.innerHTML = "";
      tableBody.innerHTML = "";

      const headRow = document.createElement("tr");

      const dayTh = document.createElement("th");
      dayTh.className = "col-day";
      dayTh.textContent = "Day";
      headRow.appendChild(dayTh);

      state.activities.forEach((name, index) => {
        const th = document.createElement("th");
        const headerDiv = document.createElement("div");
        headerDiv.className = "activity-header";

        const titleSpan = document.createElement("span");
        titleSpan.className = "activity-title";
        titleSpan.textContent = name;
        titleSpan.dataset.activityIndex = index.toString();
        titleSpan.title = "Click to rename";

        const actionsDiv = document.createElement("div");
        actionsDiv.className = "header-actions customize-only";

        const renameBtn = document.createElement("button");
        renameBtn.className = "icon-btn";
        renameBtn.type = "button";
        renameBtn.textContent = "âœï¸";
        renameBtn.title = "Rename activity";
        renameBtn.addEventListener("click", () => {
          const current = state.activities[index];
          const next = prompt("Rename activity:", current);
          if (next && next.trim()) {
            state.activities[index] = next.trim();
            saveState();
            buildTable();
            renderCompareSelect();
            renderYearOverview();
          }
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "icon-btn";
        deleteBtn.type = "button";
        deleteBtn.textContent = "ðŸ—‘ï¸";
        deleteBtn.title = "Delete activity column";
        deleteBtn.addEventListener("click", () => {
          if (state.activities.length <= 1) {
            alert("At least one activity column is required.");
            return;
          }
          if (!confirm(`Delete activity "${state.activities[index]}" from all months?`)) return;
          state.activities.splice(index, 1);
          Object.values(state.months).forEach((m) => {
            m.data.forEach((row) => {
              if (Array.isArray(row.activities)) {
                row.activities.splice(index, 1);
              }
            });
          });
          saveState();
          buildTable();
          renderCompareSelect();
          renderYearOverview();
        });

        actionsDiv.appendChild(renameBtn);
        actionsDiv.appendChild(deleteBtn);

        headerDiv.appendChild(titleSpan);
        headerDiv.appendChild(actionsDiv);

        th.appendChild(headerDiv);
        headRow.appendChild(th);
      });

      const overviewTh = document.createElement("th");
      overviewTh.textContent = "Daily completion overview";
      headRow.appendChild(overviewTh);

      tableHead.appendChild(headRow);

      for (let d = 0; d < month.days; d++) {
        if (!month.data[d]) {
          month.data[d] = {
            activities: state.activities.map(() => "none"),
            overview: null
          };
        } else {
          if (!Array.isArray(month.data[d].activities)) {
            month.data[d].activities = state.activities.map(() => "none");
          } else {
            if (month.data[d].activities.length < state.activities.length) {
              while (month.data[d].activities.length < state.activities.length) {
                month.data[d].activities.push("none");
              }
            } else if (month.data[d].activities.length > state.activities.length) {
              month.data[d].activities =
                month.data[d].activities.slice(0, state.activities.length);
            }
          }
        }

        const tr = document.createElement("tr");

        const tdDay = document.createElement("td");
        tdDay.className = "col-day";
        tdDay.textContent = d + 1;
        tr.appendChild(tdDay);

        state.activities.forEach((_, aIndex) => {
          const td = document.createElement("td");
          td.className = "activity-cell";

          const field = document.createElement("div");
          field.className = "activity-field";

          const fill = document.createElement("div");
          fill.className = "activity-fill";
          field.appendChild(fill);

          const label = document.createElement("span");
          label.className = "activity-label";
          label.textContent = "Not set";
          field.appendChild(label);

          const select = document.createElement("select");
          select.className = "activity-select";
          select.setAttribute("data-month", currentMonthKey);
          select.setAttribute("data-day", d.toString());
          select.setAttribute("data-activity", aIndex.toString());

          ACTIVITY_OPTIONS.forEach((opt) => {
            const o = document.createElement("option");
            o.value = opt.value;
            o.textContent = opt.label;
            select.appendChild(o);
          });

          select.value = month.data[d].activities[aIndex] || "none";

          select.addEventListener("change", (e) => {
            const value = e.target.value;
            month.data[d].activities[aIndex] = value;
            updateActivityCell(currentMonthKey, d, aIndex);
            updateOverviewForDay(currentMonthKey, d);
            saveState();
            updateSummaryForCurrentMonth();
            updateComparison();
            renderYearOverview();
          });

          field.appendChild(select);
          td.appendChild(field);
          tr.appendChild(td);
        });

        const tdOverview = document.createElement("td");
        tdOverview.className = "overview-cell";

        const overviewWrap = document.createElement("div");
        overviewWrap.className = "overview-linear stage-0";
        overviewWrap.setAttribute("data-month-overview", currentMonthKey);
        overviewWrap.setAttribute("data-overview-linear", d.toString());

        const track = document.createElement("div");
        track.className = "overview-linear-track";

        const ofill = document.createElement("div");
        ofill.className = "overview-linear-fill";
        track.appendChild(ofill);

        const olabel = document.createElement("div");
        olabel.className = "overview-linear-label";
        olabel.textContent = "Not set";

        overviewWrap.appendChild(track);
        overviewWrap.appendChild(olabel);
        tdOverview.appendChild(overviewWrap);
        tr.appendChild(tdOverview);

        tableBody.appendChild(tr);
      }

      for (let d = 0; d < month.days; d++) {
        for (let aIndex = 0; aIndex < state.activities.length; aIndex++) {
          updateActivityCell(currentMonthKey, d, aIndex);
        }
        updateOverviewForDay(currentMonthKey, d);
      }
      updateSummaryForCurrentMonth();
      saveState();
      renderYearOverview();

      // if we are in compare mode, keep inputs disabled
      if (compareSelect.value) {
        setInputsEnabled(false);
      } else {
        setInputsEnabled(true);
      }
    }

    // Events

    monthPicker.addEventListener("change", () => {
      const value = monthPicker.value;
      if (!value) return;
      const [y, m] = value.split("-").map(Number);
      const year = y;
      const monthIndex = m - 1;
      const key = getMonthKey(year, monthIndex);
      ensureMonth(year, monthIndex);
      currentMonthKey = key;
      buildTable();
      renderMonthPicker();
      renderCompareSelect();
      updateComparison();
    });

    addActivityBtn.addEventListener("click", () => {
      if (state.activities.length >= 8) {
        alert("For now, max 8 activity columns are allowed.");
        return;
      }
      const name = prompt("New activity name (e.g. Reading, Gym, Journaling):");
      if (!name || !name.trim()) return;
      state.activities.push(name.trim());
      Object.values(state.months).forEach((m) => {
        m.data.forEach((row) => {
          if (!Array.isArray(row.activities)) {
            row.activities = [];
          }
          row.activities.push("none");
        });
      });
      saveState();
      buildTable();
      renderCompareSelect();
      renderYearOverview();
    });

    compareSelect.addEventListener("change", updateComparison);

    resetCurrentMonthBtn.addEventListener("click", () => {
      const month = state.months[currentMonthKey];
      if (!month) return;
      const monthLabel = `${month.year}-${String(month.monthIndex + 1).padStart(2, "0")}`;
      if (!confirm(`Clear all data for ${monthLabel}?`)) return;
      month.data = Array.from({ length: month.days }, () => ({
        activities: state.activities.map(() => "none"),
        overview: null
      }));
      saveState();
      buildTable();
      updateComparison();
    });

    customizeToggle.addEventListener("click", () => {
      customizeMode = !customizeMode;
      if (customizeMode) {
        appRoot.classList.remove("customize-off");
        appRoot.classList.add("customize-on");
        customizeToggle.textContent = "âœ” Done customizing";
      } else {
        appRoot.classList.remove("customize-on");
        appRoot.classList.add("customize-off");
        customizeToggle.textContent = "âš™ Customize";
      }
    });

    // Init

    initState();
    const currentMonth = state.months[currentMonthKey];
    if (currentMonth) {
      monthPicker.value = `${currentMonth.year}-${String(currentMonth.monthIndex + 1).padStart(2, "0")}`;
    }
    buildTable();
    renderMonthPicker();
    renderCompareSelect();
    updateComparison();
  </script>
</body>
</html>
